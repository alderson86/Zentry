<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zentry Biz</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --bg-color: #f2f2f7;
            --text-color: #000;
            --navbar-bg: rgba(255, 255, 255, 0.75);
            --navbar-border: #d1d1d6;
            --container-bg: rgba(255, 255, 255, 0.75);
            --container-border: #d1d1d6;
            --header-bg: rgba(233, 233, 239, 0.75);
            --header-border: #c8c2cc;
            --table-hover: #f7f7f7;
            --table-selected: #e6f0ff;
            --input-bg: #fff;
            --input-border: #c6c6c8;
            --input-placeholder: #8e8e93;
            --button-bg: #007aff;
            --button-hover: #0a84ff;
            --button-disabled: #c6c6c8;
            --modal-bg: #fff;
            --modal-border: #d1d1d6;
            --modal-btn-secondary-bg: #e6e6eb;
            --modal-btn-secondary-hover: #d1d1d6;
            --modal-btn-danger-bg: #ff3d3d;
            --modal-btn-danger-hover: #e03838;
        }
        body.dark-mode {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --navbar-bg: rgba(30, 30, 30, 0.75);
            --navbar-border: #333;
            --container-bg: rgba(30, 30, 30, 0.75);
            --container-border: #333;
            --header-bg: rgba(43, 43, 43, 0.75);
            --header-border: #444;
            --table-hover: #2b2b2b;
            --table-selected: #3a3a3a;
            --input-bg: #2b2b2b;
            --input-border: #444;
            --input-placeholder: #a0a0a0;
            --button-bg: #005fcc;
            --button-hover: #004599;
            --button-disabled: #444;
            --modal-bg: #1e1e1e;
            --modal-border: #333;
            --modal-btn-secondary-bg: #2b2b2b;
            --modal-btn-secondary-hover: #444;
            --modal-btn-danger-bg: #cc3333;
            --modal-btn-danger-hover: #a02a2a;
        }
        body { padding-top: 70px; background-color: var(--bg-color); color: var(--text-color); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; transition: background-color 0.3s ease; }
        .glassmorphism {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            background-color: var(--container-bg);
            border: 1px solid var(--container-border);
        }
        .navbar { background-color: var(--navbar-bg) !important; border-bottom: 1px solid var(--navbar-border); position: fixed; top: 0; left: 0; right: 0; z-index: 1040; transition: background-color 0.3s ease; }
        .navbar-brand { color: var(--text-color) !important; }
        .nav-tabs .nav-link { color: var(--text-color); border: none; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: border-bottom-color 0.3s ease, color 0.3s ease; }
        .nav-tabs .nav-link.active { color: var(--button-bg); border-bottom-color: var(--button-bg); }
        .fixed-bottom-form { 
            padding: 15px;
            position: fixed; bottom: 0; left: 0; right: 0; z-index: 1030; border-radius: 8px 8px 0 0; 
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1); 
            margin: 0 10px;
            transition: background-color 0.3s ease;
        }
        .table-container { 
            max-height: 60vh; overflow-y: auto; border-radius: 8px; 
            margin: 10px;
        }
        .list-table { width: 100%; border-collapse: collapse; }
        .list-table th, .list-table td { padding: 4px 15px; white-space: nowrap; border: none; text-align: left; }
        .list-table tr { cursor: pointer; background-color: transparent; transition: background-color 0.2s ease; }
        .list-table tr:hover { background-color: var(--table-hover); }
        .list-table tr.selected { background-color: var(--table-selected); }
        .form-control, .form-select { 
            border-radius: 5px; background-color: var(--input-bg); color: var(--text-color); 
            border: 1px solid var(--input-border); padding: 8px 12px; font-size: 1rem; 
            transition: background-color 0.3s ease, border-color 0.3s ease; 
        }
        .form-control::placeholder { color: var(--input-placeholder); }
        .fixed-bottom-form .form-control, .fixed-bottom-form .form-select {
            width: 100%; height: auto; padding: 10px 15px; font-size: 1rem;
            color: var(--text-color); background-color: var(--input-bg); background-image: none;
            border: 1px solid var(--input-border); box-shadow: none;
            transition: border-color ease-in-out .15s, box-shadow ease-in-out .15s;
        }
        .fixed-bottom-form .row > div { padding-right: 5px; padding-left: 5px; }
        .btn-icon { 
            width: 40px; height: 40px; border-radius: 8px; background-color: transparent; border: none; color: var(--button-bg); 
            display: flex; justify-content: center; align-items: center; font-size: 1.2rem;
            transition: background-color 0.2s ease, transform 0.2s ease, color 0.2s ease;
        }
        .btn-icon:hover { background-color: rgba(0, 122, 255, 0.1); transform: scale(1.05); cursor: pointer; }
        .btn-icon:disabled { color: var(--button-disabled); cursor: not-allowed; background-color: transparent; }
        .modal-content { border-radius: 10px; border: none; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); background-color: var(--modal-bg); color: var(--text-color); }
        .modal-header { border-bottom: 1px solid var(--modal-border); padding: 15px; }
        .modal-title { font-size: 1.3rem; font-weight: 500; }
        .modal-body { padding: 15px; }
        .modal-footer { border-top: 1px solid var(--modal-border); padding: 15px; display: flex; justify-content: flex-end; gap: 10px; }
        .modal-footer button { border-radius: 8px; padding: 10px 15px; font-size: 1rem; }
        .modal-footer .btn-secondary { background-color: var(--modal-btn-secondary-bg); color: var(--text-color); border: 1px solid var(--input-border); transition: background-color 0.2s ease; }
        .modal-footer .btn-secondary:hover { background-color: var(--modal-btn-secondary-hover); }
        .modal-footer .btn-danger { background-color: var(--modal-btn-danger-bg); color: #fff; border: none; transition: background-color 0.2s ease; }
        .modal-footer .btn-danger:hover { background-color: var(--modal-btn-danger-hover); }
        .nav-tabs { border-bottom: 1px solid var(--navbar-border); }
        .table-header-sticky { 
            position: sticky; top: 0; background: var(--header-bg); border-radius: 8px 8px 0 0; z-index: 1020; 
            transition: background-color 0.3s ease;
        }
        .table-header-sticky .search-row {
            display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--header-border);
        }
        .info-container { display: flex; gap: 10px; font-size: 0.9rem; }
        .info-container span { background: var(--input-border); padding: 5px 8px; border-radius: 5px; color: var(--text-color); }
        .search-container { flex-grow: 1; padding-right: 15px; }
        .search-input { width: 100%; padding: 8px 12px; border-radius: 5px; border: 1px solid var(--input-border); background-color: var(--input-bg); color: var(--text-color); }
        .list-table thead th {
            position: sticky; top: 50px; background: var(--header-bg); border-bottom: 1px solid var(--header-border); z-index: 1010;
        }
        /* Animação de entrada da página */
        .tab-pane.fade {
            transition: opacity 0.5s ease-in-out;
            opacity: 0;
        }
        .tab-pane.fade.show {
            opacity: 1;
        }
        .tab-pane .list-table tbody tr {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light glassmorphism">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Biz / Aliança / Pisa</a>
            <ul class="nav nav-tabs mx-auto" id="myTab" role="tablist">
                <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#ponto">Ponto</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#entregas">Entregas</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#descargas">Descargas</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#cargas">Cargas</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#outros">Outros</a></li>
            </ul>
            <button class="btn btn-icon" id="darkModeToggle"><i class="fa-solid fa-moon"></i></button>
        </div>
    </nav>

    <div class="tab-content container mt-3 mb-5">
        <div class="tab-pane fade show active" id="ponto">
            <div class="table-container glassmorphism">
                <div class="table-header-sticky glassmorphism">
                    <div class="search-row">
                        <div class="search-container">
                            <input type="text" id="ponto-search" class="search-input" placeholder="Pesquisar...">
                        </div>
                        <div class="info-container">
                            <span id="ponto-total">Presentes: 0</span>
                            <span id="ponto-cracha-sim">Com Crachá: 0</span>
                            <span id="ponto-cracha-nao">Sem Crachá: 0</span>
                        </div>
                    </div>
                </div>
                <table class="list-table" id="lista-ponto">
                    <thead><tr><th>Data</th><th>Colaborador</th><th>Entrada</th><th>Saída</th><th>Crachá</th><th>Observações</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="fixed-bottom-form glassmorphism">
                <div class="row g-1 align-items-center justify-content-center">
                    <div class="col-md-auto"><input type="date" id="ponto-data" class="form-control"></div>
                    <div class="col-md-auto">
                        <select id="ponto-colaborador" class="form-select">
                            <option value="">Selecione</option>
                            <option>Leandro S.</option><option>Oscar -Supervisor</option><option>João Paulo - Menor Aprendiz</option>
                            <option>Vitória Isabele</option><option>Thalles</option><option>André</option><option>Ezequias</option>
                            <option>Luiz Carlos</option><option>Raimundo</option><option>Michel F. - Menor Aprendiz</option>
                            <option>João Vitor</option><option>Luiz Henrique</option><option>Cristiano</option><option>Marsergio-Gerente</option>
                            <option>André - ADM</option><option>Jean Carlos</option><option>Enildo -Supervisor</option>
                            <option>Thiago Benjamin</option><option>Jayme - Encarregado - Van</option><option>Raimundo - Van</option>
                            <option>Marcos - Van</option><option>Fábio - Van</option><option>Eriton - Van</option><option>Elionai - Van</option>
                            <option>Edmar - Van</option><option>Jefferson - Van</option><option>Wanderson</option><option>Kleverson</option>
                            <option>Leandro F.</option><option>Gilliard D.</option><option>Leandro P.</option><option>André F.</option>
                            <option>Leonardo</option><option>Dangel – Menor aprendiz</option><option>Cauan – Menor aprendiz</option>
                            <option>Nicolas G – Menor aprendiz</option><option>Elias – Menor aprendiz</option><option>Murilo - Menor Aprendiz</option>
                            <option>Matias - Menor Aprendiz</option><option>Yuri - Menor Aprendiz</option><option>Pedro H - Menor Aprendiz</option>
                            <option>Felipe - Menor Aprendiz</option><option>Abraão - Menor Aprendiz</option><option>Gabriel - Menor Aprendiz</option>
                            <option>Edirlei - CPD</option>
                        </select>
                    </div>
                    <div class="col-md-auto"><input type="time" id="ponto-entrada" class="form-control" placeholder="Hora Entrada"></div>
                    <div class="col-md-auto"><input type="time" id="ponto-saida" class="form-control" placeholder="Hora Saída"></div>
                    <div class="col-md-auto">
                        <select id="ponto-cracha" class="form-select">
                            <option>Sim</option><option>Não</option>
                        </select>
                    </div>
                    <div class="col-md-auto"><input type="text" id="ponto-obs" class="form-control" placeholder="Observações"></div>
                    <div class="col-md-auto">
                        <button class="btn btn-icon" id="salvar-btn-ponto" onclick="salvar('ponto')"><i class="fa-solid fa-floppy-disk"></i></button>
                    </div>
                    <div class="col-md-auto">
                        <button class="btn btn-icon" id="editar-btn-ponto" disabled onclick="confirmarEdicao('ponto')"><i class="fa-solid fa-pencil"></i></button>
                    </div>
                    <div class="col-md-auto">
                        <button class="btn btn-icon" id="excluir-btn-ponto" disabled onclick="confirmarExclusao('ponto')"><i class="fa-solid fa-trash"></i></button>
                    </div>
                    <div class="col-md-auto">
                        <button class="btn btn-icon" onclick="exportarRelatorioCompleto('ponto')"><i class="fa-solid fa-download"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="entregas">
            <div class="table-container glassmorphism">
                <div class="table-header-sticky glassmorphism">
                    <div class="search-row">
                        <div class="search-container">
                            <input type="text" id="entregas-search" class="search-input" placeholder="Pesquisar...">
                        </div>
                        <div class="info-container">
                            <span id="entregas-total">Veículos no Pátio: 0</span>
                        </div>
                    </div>
                </div>
                <table class="list-table" id="lista-entregas">
                    <thead><tr><th>Data</th><th>Motorista</th><th>Frota</th><th>Saída</th><th>Chegada</th><th>Observações</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="fixed-bottom-form glassmorphism">
                <div class="row g-1 align-items-center justify-content-center">
                    <div class="col-md-auto"><input type="date" id="entregas-data" class="form-control"></div>
                    <div class="col-md-auto"><input type="text" id="entregas-motorista" class="form-control" placeholder="Motorista"></div>
                    <div class="col-md-auto"><input type="text" id="entregas-frota" class="form-control" placeholder="Frota"></div>
                    <div class="col-md-auto"><input type="time" id="entregas-saida" class="form-control"></div>
                    <div class="col-md-auto"><input type="time" id="entregas-chegada" class="form-control"></div>
                    <div class="col-md-auto"><input type="text" id="entregas-obs" class="form-control" placeholder="Observações"></div>
                    <div class="col-md-auto">
                        <button class="btn btn-icon" id="salvar-btn-entregas" onclick="salvar('entregas')"><i class="fa-solid fa-floppy-disk"></i></button>
                    </div>
                    <div class="col-md-auto">
                        <button class="btn btn-icon" id="editar-btn-entregas" disabled onclick="confirmarEdicao('entregas')"><i class="fa-solid fa-pencil"></i></button>
                    </div>
                    <div class="col-md-auto">
                        <button class="btn btn-icon" id="excluir-btn-entregas" disabled onclick="confirmarExclusao('entregas')"><i class="fa-solid fa-trash"></i></button>
                    </div>
                    <div class="col-md-auto">
                        <button class="btn btn-icon" onclick="exportarRelatorioCompleto('entregas')"><i class="fa-solid fa-download"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="descargas">
            <div class="table-container glassmorphism">
                <div class="table-header-sticky glassmorphism">
                    <div class="search-row">
                        <div class="search-container">
                            <input type="text" id="descargas-search" class="search-input" placeholder="Pesquisar...">
                        </div>
                        <div></div>
                    </div>
                </div>
                <table class="list-table" id="lista-descargas">
                    <thead><tr><th>Data</th><th>Hora</th><th>Nome</th><th>CPF</th><th>Celular</th><th>Placa CV</th><th>Placa RB</th><th>Transp</th><th>Fornecedor</th><th>NF/SH</th><th>Quantidade</th><th>Tipo</th><th>Obs</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="fixed-bottom-form glassmorphism">
                <div class="row g-1 align-items-center justify-content-center">
                    <div class="col-md-auto"><input type="date" id="descargas-data" class="form-control"></div>
                    <div class="col-md-auto"><input type="time" id="descargas-hora" class="form-control" placeholder="Hora"></div>
                    <div class="col-md-auto"><input type="text" id="descargas-nome" class="form-control" placeholder="Nome"></div>
                    <div class="col-md-auto"><input type="text" id="descargas-cpf" class="form-control" placeholder="CPF"></div>
                    <div class="col-md-auto"><input type="text" id="descargas-celular" class="form-control" placeholder="Celular"></div>
                    <div class="col-md-auto"><input type="text" id="descargas-placacv" class="form-control" placeholder="Placa CV"></div>
                    <div class="col-md-auto"><input type="text" id="descargas-placarb" class="form-control" placeholder="Placa RB"></div>
                    <div class="col-md-auto"><input type="text" id="descargas-transp" class="form-control" placeholder="Transp"></div>
                    <div class="col-md-auto"><input type="text" id="descargas-fornecedor" class="form-control" placeholder="Fornecedor"></div>
                    <div class="col-md-auto"><input type="text" id="descargas-nfsh" class="form-control" placeholder="NF/SH"></div>
                    <div class="col-md-auto"><input type="number" id="descargas-quantidade" class="form-control" placeholder="Quantidade"></div>
                    <div class="col-md-auto">
                        <select id="descargas-tipo" class="form-select">
                            <option value="">Tipo</option>
                            <option>Paletizada</option>
                            <option>Batida</option>
                            <option>Volumosa</option>
                        </select>
                    </div>
                    <div class="col-md-auto"><input type="text" id="descargas-obs" class="form-control" placeholder="Obs"></div>
                    <div class="col-md-auto">
                        <button class="btn btn-icon" id="salvar-btn-descargas" onclick="salvar('descargas')"><i class="fa-solid fa-floppy-disk"></i></button>
                    </div>
                    <div class="col-md-auto">
                        <button class="btn btn-icon" id="editar-btn-descargas" disabled onclick="confirmarEdicao('descargas')"><i class="fa-solid fa-pencil"></i></button>
                    </div>
                    <div class="col-md-auto">
                        <button class="btn btn-icon" id="excluir-btn-descargas" disabled onclick="confirmarExclusao('descargas')"><i class="fa-solid fa-trash"></i></button>
                    </div>
                    <div class="col-md-auto">
                        <button class="btn btn-icon" onclick="exportarRelatorioCompleto('descargas')"><i class="fa-solid fa-download"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="cargas">
            <div class="table-container glassmorphism">
                <div class="table-header-sticky glassmorphism">
                    <div class="search-row">
                        <div class="search-container">
                            <input type="text" id="cargas-search" class="search-input" placeholder="Pesquisar...">
                        </div>
                        <div></div>
                    </div>
                </div>
                <table class="list-table" id="lista-cargas">
                    <thead><tr><th>Data</th><th>Entrada</th><th>Motorista</th><th>Documento</th><th>Contato</th><th>Cliente</th><th>Placas</th><th>Autorização</th><th>Observações</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="fixed-bottom-form glassmorphism">
                <div class="row g-1 align-items-center justify-content-center">
                    <div class="col-md-auto"><input type="date" id="cargas-data" class="form-control"></div>
                    <div class="col-md-auto"><input type="time" id="cargas-entrada" class="form-control"></div>
                    <div class="col-md-auto"><input type="text" id="cargas-motorista" class="form-control" placeholder="Motorista"></div>
                    <div class="col-md-auto"><input type="text" id="cargas-doc" class="form-control" placeholder="Documento"></div>
                    <div class="col-md-auto"><input type="text" id="cargas-contato" class="form-control" placeholder="Contato"></div>
                    <div class="col-md-auto"><input type="text" id="cargas-cliente" class="form-control" placeholder="Cliente"></div>
                    <div class="col-md-auto"><input type="text" id="cargas-placas" class="form-control" placeholder="Placas"></div>
                    <div class="col-md-auto"><input type="text" id="cargas-autorizacao" class="form-control" placeholder="Autorização"></div>
                    <div class="col-md-auto"><input type="text" id="cargas-obs" class="form-control" placeholder="Observações"></div>
                    <div class="col-md-auto">
                        <button class="btn btn-icon" id="salvar-btn-cargas" onclick="salvar('cargas')"><i class="fa-solid fa-floppy-disk"></i></button>
                    </div>
                    <div class="col-md-auto">
                        <button class="btn btn-icon" id="editar-btn-cargas" disabled onclick="confirmarEdicao('cargas')"><i class="fa-solid fa-pencil"></i></button>
                    </div>
                    <div class="col-md-auto">
                        <button class="btn btn-icon" id="excluir-btn-cargas" disabled onclick="confirmarExclusao('cargas')"><i class="fa-solid fa-trash"></i></button>
                    </div>
                    <div class="col-md-auto">
                        <button class="btn btn-icon" onclick="exportarRelatorioCompleto('cargas')"><i class="fa-solid fa-download"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="outros">
            <div class="table-container glassmorphism">
                <div class="table-header-sticky glassmorphism">
                    <div class="search-row">
                        <div class="search-container">
                            <input type="text" id="outros-search" class="search-input" placeholder="Pesquisar...">
                        </div>
                        <div></div>
                    </div>
                </div>
                <table class="list-table" id="lista-outros">
                    <thead><tr><th>Data</th><th>Hora</th><th>Nome</th><th>CPF/Placa</th><th>Empresa</th><th>Autorização</th><th>Observações</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="fixed-bottom-form glassmorphism">
                <div class="row g-1 align-items-center justify-content-center">
                    <div class="col-md-auto"><input type="date" id="outros-data" class="form-control"></div>
                    <div class="col-md-auto"><input type="time" id="outros-hora" class="form-control"></div>
                    <div class="col-md-auto"><input type="text" id="outros-nome" class="form-control" placeholder="Nome"></div>
                    <div class="col-md-auto"><input type="text" id="outros-doc" class="form-control" placeholder="CPF/Placa"></div>
                    <div class="col-md-auto"><input type="text" id="outros-empresa" class="form-control" placeholder="Empresa"></div>
                    <div class="col-md-auto"><input type="text" id="outros-autorizacao" class="form-control" placeholder="Autorização"></div>
                    <div class="col-md-auto"><input type="text" id="outros-obs" class="form-control" placeholder="Observações"></div>
                    <div class="col-md-auto">
                        <button class="btn btn-icon" id="salvar-btn-outros" onclick="salvar('outros')"><i class="fa-solid fa-floppy-disk"></i></button>
                    </div>
                    <div class="col-md-auto">
                        <button class="btn btn-icon" id="editar-btn-outros" disabled onclick="confirmarEdicao('outros')"><i class="fa-solid fa-pencil"></i></button>
                    </div>
                    <div class="col-md-auto">
                        <button class="btn btn-icon" id="excluir-btn-outros" disabled onclick="confirmarExclusao('outros')"><i class="fa-solid fa-trash"></i></button>
                    </div>
                    <div class="col-md-auto">
                        <button class="btn btn-icon" onclick="exportarRelatorioCompleto('outros')"><i class="fa-solid fa-download"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Confirmação</h5></div>
                <div class="modal-body" id="confirmModalBody"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmAction">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script>
        let itemSelecionado = null;
        let confirmModal = null;
        let headersMap = {
            'ponto': ['data', 'colaborador', 'entrada', 'saida', 'cracha', 'obs'],
            'entregas': ['data', 'motorista', 'frota', 'saida', 'chegada', 'obs'],
            'descargas': ['data', 'hora', 'nome', 'cpf', 'celular', 'placacv', 'placarb', 'transp', 'fornecedor', 'nfsh', 'quantidade', 'tipo', 'obs'],
            'cargas': ['data', 'entrada', 'motorista', 'doc', 'contato', 'cliente', 'placas', 'autorizacao', 'obs'],
            'outros': ['data', 'hora', 'nome', 'doc', 'empresa', 'autorizacao', 'obs']
        };

        document.addEventListener('DOMContentLoaded', () => {
            confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));

            const abas = ['ponto', 'entregas', 'descargas', 'cargas', 'outros'];
            abas.forEach(aba => {
                render(aba);
                const searchInput = document.getElementById(`${aba}-search`);
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        render(aba, e.target.value);
                    });
                }
            });

            document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
            agendarExportacaoAutomatica();
        });

        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('shown.bs.tab', () => {
                const aba = getAbaAtiva();
                reiniciarBotoes(aba);
                limparCampos(aba);
            });
        });

        function getAbaAtiva() {
            const abas = ['ponto', 'entregas', 'descargas', 'cargas', 'outros'];
            return abas.find(aba => document.getElementById(aba).classList.contains('show'));
        }

        function ordenarDadosPorDataEHora(lista, aba) {
            const camposDeData = {
                'ponto': 'data', 'entregas': 'data', 'descargas': 'data', 'cargas': 'data', 'outros': 'data'
            };
            const camposDeHora = {
                'ponto': 'entrada', 'entregas': 'saida', 'descargas': 'hora', 'cargas': 'entrada', 'outros': 'hora'
            };
            const campoData = camposDeData[aba];
            const campoHora = camposDeHora[aba];
            lista.sort((a, b) => {
                const dataA = a[campoData];
                const horaA = a[campoHora] || '00:00';
                const dataB = b[campoData];
                const horaB = b[campoHora] || '00:00';
                const dateTimeA = new Date(`${dataA}T${horaA}`);
                const dateTimeB = new Date(`${dataB}T${horaB}`);
                return dateTimeA - dateTimeB;
            });
            return lista;
        }

        function salvar(aba) {
            const inputs = document.querySelectorAll(`#${aba} input, #${aba} select`);
            const dados = {};
            inputs.forEach(inp => {
                const key = inp.id.split('-')[1];
                dados[key] = inp.value;
            });

            if (!dados.data) {
                alert("Por favor, preencha o campo de data.");
                return;
            }

            let lista = JSON.parse(localStorage.getItem(aba) || '[]');
            
            if (itemSelecionado && itemSelecionado.aba === aba && itemSelecionado.index !== null) {
                lista[itemSelecionado.index] = dados;
                itemSelecionado = null;
            } else {
                lista.push(dados);
            }
            
            lista = ordenarDadosPorDataEHora(lista, aba);
            localStorage.setItem(aba, JSON.stringify(lista));
            render(aba);
            limparCampos(aba);
            
            // Nova funcionalidade: Rolar para o final da tabela após salvar
            const tableContainer = document.querySelector(`#${aba} .table-container`);
            tableContainer.scrollTo({ top: tableContainer.scrollHeight, behavior: 'smooth' });
        }

        function render(aba, filtro = '') {
            const listaOriginal = JSON.parse(localStorage.getItem(aba) || '[]');
            const tbody = document.querySelector(`#lista-${aba} tbody`);
            tbody.innerHTML = '';
            
            let listaFiltrada = listaOriginal;
            if (filtro) {
                const filtroLowerCase = filtro.toLowerCase();
                listaFiltrada = listaOriginal.filter(item => {
                    return Object.values(item).some(value => 
                        value.toString().toLowerCase().includes(filtroLowerCase)
                    );
                });
            }

            listaFiltrada.forEach((item, i) => {
                const tr = document.createElement('tr');
                tr.onclick = () => selecionarItem(tr, aba, i);
                const itemKeys = headersMap[aba];
                itemKeys.forEach(key => {
                    const td = document.createElement('td');
                    td.textContent = item[key] || '';
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            
            atualizarContadores(aba, listaOriginal);
            reiniciarBotoes(aba);
        }

        function atualizarContadores(aba, lista) {
            if (aba === 'ponto') {
                const presentes = lista.filter(item => item.entrada && !item.saida).length;
                const crachaSim = lista.filter(item => item.cracha === 'Sim').length;
                const crachaNao = lista.filter(item => item.cracha === 'Não').length;
                document.getElementById('ponto-total').textContent = `Presentes: ${presentes}`;
                document.getElementById('ponto-cracha-sim').textContent = `Com Crachá: ${crachaSim}`;
                document.getElementById('ponto-cracha-nao').textContent = `Sem Crachá: ${crachaNao}`;
            } else if (aba === 'entregas') {
                const noPatio = lista.filter(item => item.chegada && !item.saida).length;
                document.getElementById('entregas-total').textContent = `Veículos no Pátio: ${noPatio}`;
            }
        }

        function selecionarItem(tr, aba, index) {
            const tabela = document.querySelector(`#lista-${aba}`);
            const todasTr = tabela.querySelectorAll('tr');
            todasTr.forEach(row => row.classList.remove('selected'));
            tr.classList.add('selected');

            itemSelecionado = { aba, index };
            const lista = JSON.parse(localStorage.getItem(aba) || '[]');
            const item = lista[index];
            preencherCampos(aba, item);

            const editarBtn = document.getElementById(`editar-btn-${aba}`);
            const excluirBtn = document.getElementById(`excluir-btn-${aba}`);
            editarBtn.disabled = false;
            excluirBtn.disabled = false;
        }

        function preencherCampos(aba, item) {
            const inputs = document.querySelectorAll(`#${aba} input, #${aba} select`);
            inputs.forEach(inp => {
                const key = inp.id.split('-')[1];
                if (item[key] !== undefined) {
                    inp.value = item[key];
                }
            });
        }

        function confirmarEdicao(aba) {
            if (itemSelecionado) {
                document.getElementById('confirmModalBody').textContent = "Deseja editar este item?";
                document.getElementById('confirmAction').className = 'btn btn-info';
                document.getElementById('confirmAction').textContent = 'Editar';
                document.getElementById('confirmAction').onclick = () => {
                    salvar(aba);
                    confirmModal.hide();
                };
                confirmModal.show();
            }
        }

        function confirmarExclusao(aba) {
            if (itemSelecionado) {
                document.getElementById('confirmModalBody').textContent = "Deseja excluir este item?";
                document.getElementById('confirmAction').className = 'btn btn-danger';
                document.getElementById('confirmAction').textContent = 'Excluir';
                document.getElementById('confirmAction').onclick = () => {
                    excluirItem(aba, itemSelecionado.index);
                    confirmModal.hide();
                };
                confirmModal.show();
            }
        }

        function excluirItem(aba, index) {
            const lista = JSON.parse(localStorage.getItem(aba) || '[]');
            lista.splice(index, 1);
            localStorage.setItem(aba, JSON.stringify(lista));
            render(aba);
            limparCampos(aba);
        }

        function reiniciarBotoes(aba) {
            const editarBtn = document.getElementById(`editar-btn-${aba}`);
            const excluirBtn = document.getElementById(`excluir-btn-${aba}`);
            editarBtn.disabled = true;
            excluirBtn.disabled = true;
            itemSelecionado = null;
        }

        function limparCampos(aba) {
            const inputs = document.querySelectorAll(`#${aba} input, #${aba} select`);
            inputs.forEach(inp => {
                if (inp.type === 'date' || inp.type === 'time' || inp.type === 'text' || inp.type === 'number') {
                    inp.value = '';
                } else if (inp.tagName === 'SELECT') {
                    inp.selectedIndex = 0;
                }
            });
        }

        function exportarParaXLSX(data, filename) {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Registros");
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            saveAs(new Blob([wbout], { type: 'application/octet-stream' }), filename);
        }

        function exportarParaJSON(data, filename) {
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: "application/json" });
            saveAs(blob, filename);
        }

        function exportarRelatorioCompleto(aba, dataParaNome) {
            const lista = JSON.parse(localStorage.getItem(aba) || '[]');
            if (lista.length === 0) {
                alert("Não há dados para exportar nesta seção.");
                return;
            }
            const dataHora = dataParaNome || new Date();
            const dataFormatada = `${dataHora.getFullYear()}-${(dataHora.getMonth() + 1).toString().padStart(2, '0')}-${dataHora.getDate().toString().padStart(2, '0')}_${dataHora.getHours().toString().padStart(2, '0')}-${dataHora.getMinutes().toString().padStart(2, '0')}`;
            const filenameBase = `biz_${aba}_${dataFormatada}`;

            exportarParaXLSX(lista, `${filenameBase}.xlsx`);
            exportarParaJSON(lista, `${filenameBase}.json`);
        }

        function agendarExportacaoAutomatica() {
            const agora = new Date();
            const meiaNoite = new Date(agora);
            meiaNoite.setDate(agora.getDate() + 1);
            meiaNoite.setHours(0, 0, 0, 0);
            const tempoParaMeiaNoite = meiaNoite.getTime() - agora.getTime();
            setTimeout(() => {
                const abas = ['ponto', 'entregas', 'descargas', 'cargas', 'outros'];
                const dataExportacao = new Date();
                abas.forEach(aba => {
                    const lista = JSON.parse(localStorage.getItem(aba) || '[]');
                    if (lista.length > 0) {
                        exportarRelatorioCompleto(aba, dataExportacao);
                        localStorage.removeItem(aba);
                        render(aba);
                    }
                });
                agendarExportacaoAutomatica();
            }, tempoParaMeiaNoite);
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const icon = document.getElementById('darkModeToggle').querySelector('i');
            if (document.body.classList.contains('dark-mode')) {
                icon.className = 'fa-solid fa-sun';
            } else {
                icon.className = 'fa-solid fa-moon';
            }
        }
    </script>
</body>
</html>
