<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Registro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --bg-color: #f2f2f7;
            --text-color: #000;
            --navbar-bg: rgba(255, 255, 255, 0.75);
            --navbar-border: #d1d1d6;
            --container-bg: rgba(255, 255, 255, 0.75);
            --container-border: #d1d1d6;
            --header-bg: rgba(233, 233, 239, 0.75);
            --header-border: #c8c2cc;
            --table-hover: #f7f7f7;
            --table-selected: #e6f0ff;
            --input-bg: #fff;
            --input-border: #c6c6c8;
            --input-placeholder: #8e8e93;
            --button-bg: #007aff;
            --button-hover: #0a84ff;
            --button-disabled: #c6c6c8;
            --modal-bg: #fff;
            --modal-border: #d1d1d6;
            --modal-btn-secondary-bg: #e6e6eb;
            --modal-btn-secondary-hover: #d1d1d6;
            --modal-btn-danger-bg: #ff3d3d;
            --modal-btn-danger-hover: #e03838;
            --card-bg: #ffffff;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --toast-bg: rgba(0, 0, 0, 0.85);
            --toast-color: #fff;
            --terminal-bg: #e6e6eb;
            --terminal-text: #2c2c2e;
        }
        body.dark-mode {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --navbar-bg: rgba(30, 30, 30, 0.75);
            --navbar-border: #333;
            --container-bg: rgba(30, 30, 30, 0.75);
            --container-border: #333;
            --header-bg: rgba(43, 43, 43, 0.75);
            --header-border: #444;
            --table-hover: #2b2b2b;
            --table-selected: #3a3a3a;
            --input-bg: #2b2b2b;
            --input-border: #444;
            --input-placeholder: #a0a0a0;
            --button-bg: #005fcc;
            --button-hover: #004599;
            --button-disabled: #444;
            --modal-bg: #1e1e1e;
            --modal-border: #333;
            --modal-btn-secondary-bg: #2b2b2b;
            --modal-btn-secondary-hover: #444;
            --modal-btn-danger-bg: #cc3333;
            --modal-btn-danger-hover: #a02a2a;
            --card-bg: #1e1e1e;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            --toast-bg: rgba(255, 255, 255, 0.85);
            --toast-color: #000;
            --terminal-bg: #2c2c2e;
            --terminal-text: #00ff7f;
            color: var(--text-color) !important;
        }
        body { padding-top: 70px; background-color: var(--bg-color); color: var(--text-color); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; transition: background-color 0.3s ease; }
        .glassmorphism {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            background-color: var(--container-bg);
            border: 1px solid var(--container-border);
        }
        .navbar { background-color: var(--navbar-bg) !important; border-bottom: 1px solid var(--navbar-border); position: fixed; top: 0; left: 0; right: 0; z-index: 1040; transition: background-color 0.3s ease; }
        .navbar-brand { color: var(--text-color) !important; }
        .nav-tabs .nav-link { color: var(--text-color); border: none; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: border-bottom-color 0.3s ease, color 0.3s ease; }
        .nav-tabs .nav-link.active { color: var(--button-bg); border-bottom-color: var(--button-bg); }
        .fixed-bottom-form { 
            padding: 15px;
            position: fixed; bottom: 0; left: 0; right: 0; z-index: 1030; border-radius: 8px 8px 0 0; 
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1); 
            margin: 0 10px;
            transition: background-color 0.3s ease;
        }
        .table-container { 
            max-height: 60vh; overflow-y: auto; border-radius: 8px; 
            margin: 10px;
        }
        .list-table { width: 100%; border-collapse: collapse; }
        .list-table th, .list-table td { padding: 4px 15px; white-space: nowrap; border: none; text-align: left; }
        .list-table tr { cursor: pointer; background-color: transparent; transition: background-color 0.2s ease; }
        .list-table tr:hover { background-color: var(--table-hover); }
        .list-table tr.selected { background-color: var(--table-selected); }
        .form-control, .form-select { 
            border-radius: 5px; background-color: var(--input-bg); color: var(--text-color); 
            border: 1px solid var(--input-border); padding: 8px 12px; font-size: 1rem; 
            transition: background-color 0.3s ease, border-color 0.3s ease; 
        }
        .form-control::placeholder { color: var(--input-placeholder); }
        .fixed-bottom-form .form-control, .fixed-bottom-form .form-select {
            width: 100%; height: auto; padding: 10px 15px; font-size: 1rem;
            color: var(--text-color); background-color: var(--input-bg); background-image: none;
            border: 1px solid var(--input-border); box-shadow: none;
            transition: border-color ease-in-out .15s, box-shadow ease-in-out .15s;
        }
        .fixed-bottom-form .row > div { padding-right: 5px; padding-left: 5px; }
        .btn-icon { 
            width: 40px; height: 40px; border-radius: 8px; background-color: transparent; border: none; color: var(--button-bg); 
            display: flex; justify-content: center; align-items: center; font-size: 1.2rem;
            transition: background-color 0.2s ease, transform 0.2s ease, color 0.2s ease;
        }
        .btn-icon:hover { background-color: rgba(0, 122, 255, 0.1); transform: scale(1.05); cursor: pointer; }
        .btn-icon:disabled { color: var(--button-disabled); cursor: not-allowed; background-color: transparent; }
        .modal-content { border-radius: 10px; border: none; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); background-color: var(--modal-bg); color: var(--text-color); }
        .modal-header { border-bottom: 1px solid var(--modal-border); padding: 15px; }
        .modal-title { font-size: 1.3rem; font-weight: 500; }
        .modal-body { padding: 15px; }
        .modal-footer { border-top: 1px solid var(--modal-border); padding: 15px; display: flex; justify-content: flex-end; gap: 10px; }
        .modal-footer button { border-radius: 8px; padding: 10px 15px; font-size: 1rem; }
        .modal-footer .btn-secondary { background-color: var(--modal-btn-secondary-bg); color: var(--text-color); border: 1px solid var(--input-border); transition: background-color 0.2s ease; }
        .modal-footer .btn-secondary:hover { background-color: var(--modal-btn-secondary-hover); }
        .modal-footer .btn-danger { background-color: var(--modal-btn-danger-bg); color: #fff; border: none; transition: background-color 0.2s ease; }
        .modal-footer .btn-danger:hover { background-color: var(--modal-btn-danger-hover); }
        .nav-tabs { border-bottom: 1px solid var(--navbar-border); }
        .table-header-sticky { 
            position: sticky; top: 0; background: var(--header-bg); border-radius: 8px 8px 0 0; z-index: 1020; 
            transition: background-color 0.3s ease;
        }
        .table-header-sticky .search-row {
            display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--header-border);
        }
        .info-container { display: flex; gap: 10px; font-size: 0.9rem; flex-wrap: wrap; }
        .info-container span { background: var(--input-border); padding: 5px 8px; border-radius: 5px; color: var(--text-color); }
        .search-container { flex-grow: 1; padding-right: 15px; }
        .search-input { width: 100%; padding: 8px 12px; border-radius: 5px; border: 1px solid var(--input-border); background-color: var(--input-bg); color: var(--text-color); }
        .list-table thead th {
            position: sticky; top: 50px; background: var(--header-bg); border-bottom: 1-px solid var(--header-border); z-index: 1010;
        }
        .tab-pane.fade {
            transition: opacity 0.5s ease-in-out;
            opacity: 0;
        }
        .tab-pane.fade.show {
            opacity: 1;
        }
        .tab-pane .list-table tbody tr {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chart-container {
            width: 100%;
            height: 400px;
            margin-bottom: 20px;
            position: relative;
        }
        .frota-status-green { color: green; font-weight: bold; }
        .frota-status-red { color: red; font-weight: bold; }
        .frota-status-warning { color: orange; font-weight: bold; }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .dashboard-card {
            background-color: var(--card-bg);
            border: 1px solid var(--container-border);
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .dashboard-card .icon {
            font-size: 2.5rem;
            color: var(--button-bg);
            margin-bottom: 10px;
        }
        .dashboard-card .title {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text-color);
            margin-bottom: 5px;
        }
        .dashboard-card .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-color);
        }
        .dashboard-card .value.warning {
            color: orange;
        }
        .dashboard-card .sub-values {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-top: 10px;
        }
        .dashboard-card .sub-value {
            font-size: 1rem;
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .dashboard-card .sub-value .label {
            font-size: 0.8rem;
            color: var(--text-color);
            opacity: 0.7;
        }
        
        .dashboard-chart-container {
            background-color: var(--card-bg);
            border: 1px solid var(--container-border);
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--card-shadow);
        }
        
        .toast-container {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 1050;
        }
        #hidden-pdf-container {
            position: absolute;
            left: -9999px;
            width: 800px;
            height: auto;
            background: #fff;
            color: #000;
        }
        .dashboard-terminal-card {
            background-color: var(--terminal-bg);
            border: 1px solid var(--container-border);
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            display: flex;
            flex-direction: column;
            text-align: left;
        }
        .dashboard-terminal-card .title {
            color: var(--text-color);
            font-weight: 500;
            margin-bottom: 10px;
        }
        .terminal-log-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9rem;
            color: var(--terminal-text);
            max-height: 200px;
            overflow-y: auto;
        }
        .terminal-log-list li {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 2px 0;
        }
        /* Estilos da tela de login e primeiro acesso */
        .modal-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .modal-content-custom {
            background-color: var(--modal-bg);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 400px;
            text-align: center;
            border: 1px solid var(--modal-border);
        }
        .modal-content-custom h3 {
            margin-bottom: 20px;
            color: var(--text-color);
        }
        .modal-content-custom .form-label {
            text-align: left;
            display: block;
        }
        .modal-content-custom .form-control {
            margin-bottom: 15px;
        }
        .modal-content-custom .btn-custom {
            width: 100%;
            padding: 10px;
            background-color: var(--button-bg);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            transition: background-color 0.2s;
        }
        .modal-content-custom .btn-custom:hover {
            background-color: var(--button-hover);
        }
        .modal-content-custom .btn-link {
            font-size: 0.9rem;
            color: var(--button-bg);
            text-decoration: none;
            margin-top: 10px;
            display: block;
        }
        /* Estilos da aba Sistema */
        .sistema-container .btn {
            padding: 12px 20px;
            font-size: 1.1rem;
        }
    </style>
</head>
<body>
    <div class="modal-container" id="firstAccessModal" style="display: none;">
        <div class="modal-content-custom">
            <h3 class="mb-4">Primeiro Acesso - Cadastro de Administrador</h3>
            <div class="alert alert-info" role="alert">
                Não há usuários cadastrados. Crie o primeiro usuário administrador para prosseguir.
            </div>
            <form id="firstAccessForm">
                <div class="mb-3">
                    <label for="adminName" class="form-label">Nome Completo</label>
                    <input type="text" class="form-control" id="adminName" required>
                </div>
                <div class="mb-3">
                    <label for="adminUsername" class="form-label">Usuário</label>
                    <input type="text" class="form-control" id="adminUsername" required>
                </div>
                <div class="mb-3">
                    <label for="adminPassword" class="form-label">Senha</label>
                    <input type="password" class="form-control" id="adminPassword" required>
                </div>
                <div class="mb-3">
                    <label for="adminConfirmPassword" class="form-label">Confirmar Senha</label>
                    <input type="password" class="form-control" id="adminConfirmPassword" required>
                </div>
                <button type="submit" class="btn btn-primary btn-custom">Cadastrar Administrador</button>
                <div id="firstAccessFeedback" class="mt-3 text-danger"></div>
            </form>
        </div>
    </div>

    <div class="modal-container" id="loginModal" style="display: none;">
        <div class="modal-content-custom">
            <h3 class="mb-4">Login no Sistema</h3>
            <form id="loginForm">
                <div class="mb-3">
                    <label for="loginUsername" class="form-label">Usuário</label>
                    <input type="text" class="form-control" id="loginUsername" required>
                </div>
                <div class="mb-3">
                    <label for="loginPassword" class="form-label">Senha</label>
                    <input type="password" class="form-control" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-primary btn-custom">Logar</button>
            </form>
            <button class="btn btn-link mt-2" onclick="showRecoverPasswordModal()">Recuperar Senha</button>
            <div id="loginFeedback" class="mt-3 text-danger"></div>
        </div>
    </div>
    
    <div class="modal-container" id="recoverPasswordModal" style="display: none;">
        <div class="modal-content-custom">
            <h3 class="mb-4">Recuperar Senha</h3>
            <form id="recoverForm">
                <div class="mb-3">
                    <label for="recoverCpf" class="form-label">CPF</label>
                    <input type="text" class="form-control" id="recoverCpf" required>
                </div>
                <div class="mb-3">
                    <label for="recoverEmail" class="form-label">E-mail</label>
                    <input type="email" class="form-control" id="recoverEmail" required>
                </div>
                <button type="submit" class="btn btn-primary btn-custom">Recuperar</button>
            </form>
            <button class="btn btn-link mt-2" onclick="showLoginModal()">Voltar para o Login</button>
            <div id="recoverFeedback" class="mt-3"></div>
        </div>
    </div>

    <div class="modal fade" id="masterPasswordModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Acesso Restrito</h5>
                </div>
                <div class="modal-body">
                    <p>Por favor, insira a senha mestra para exportar os logs.</p>
                    <input type="password" class="form-control" id="masterPasswordInput" placeholder="Senha Mestra">
                    <div id="masterPasswordFeedback" class="mt-2 text-danger"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="confirmExportLogs()">Exportar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="systemContent" style="display: none;">
        <nav class="navbar navbar-expand-lg navbar-light glassmorphism">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">Registros</a>
                <ul class="nav nav-tabs mx-auto" id="myTab" role="tablist">
                    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#dashboard">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#ponto">Ponto</a></li>
                    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#entregas">Entregas</a></li>
                    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#descargas">Descargas</a></li>
                    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#cargas">Cargas</a></li>
                    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#outros">Outros</a></li>
                    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#sistema">Sistema</a></li>
                    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#sobre">Sobre</a></li>
                </ul>
                <div class="d-flex align-items-center">
                    <span id="userNameDisplay" class="me-2 text-truncate" style="max-width: 120px;"></span>
                    <button class="btn btn-icon" id="darkModeToggle"><i class="fa-solid fa-moon"></i></button>
                    <button class="btn btn-icon" onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i></button>
                </div>
            </div>
        </nav>

        <div class="tab-content container mt-3 mb-5">
            <div class="tab-pane fade show active" id="dashboard">
                <div class="container p-3 mt-3">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 class="mb-0">Painel de Monitoramento</h3>
                        <button class="btn btn-primary" onclick="exportarDashboardPDF()"><i class="fa-solid fa-file-pdf me-2"></i>Exportar PDF</button>
                    </div>
                    <div class="dashboard-grid">
                        <div class="dashboard-card">
                            <i class="fa-solid fa-truck-ramp-box icon"></i>
                            <div class="title">Movimentação Frotas Biz/Aliança</div>
                            <div class="sub-values">
                                <div class="sub-value">
                                    <span class="value" id="dashboard-frotas-entraram">0</span>
                                    <span class="label">Entraram</span>
                                </div>
                                <div class="sub-value">
                                    <span class="value" id="dashboard-frotas-sairam">0</span>
                                    <span class="label">Saíram</span>
                                </div>
                                <div class="sub-value">
                                    <span class="value" id="dashboard-frotas-patio">0</span>
                                    <span class="label">No Pátio</span>
                                </div>
                            </div>
                        </div>
                        <div class="dashboard-card">
                            <i class="fa-solid fa-handshake icon"></i>
                            <div class="title">Média de Permanência (Frota)</div>
                            <div class="value" id="dashboard-media-permanencia">0h 0m</div>
                        </div>
                        <div class="dashboard-card">
                            <i class="fa-solid fa-boxes-stacked icon"></i>
                            <div class="title">Volume de Descargas Hoje</div>
                            <div class="value" id="dashboard-descargas-hoje">0</div>
                        </div>
                        <div class="dashboard-card">
                            <i class="fa-solid fa-box-open icon"></i>
                            <div class="title">Volume de Cargas Hoje</div>
                            <div class="value" id="dashboard-cargas-hoje">0</div>
                        </div>

                        <div class="dashboard-card">
                            <i class="fa-solid fa-user-clock icon"></i>
                            <div class="title">Status do Ponto</div>
                            <div class="sub-values">
                                <div class="sub-value">
                                    <span class="value" id="dashboard-ponto-na-empresa">0</span>
                                    <span class="label">Na Empresa</span>
                                </div>
                                <div class="sub-value">
                                    <span class="value" id="dashboard-ponto-fora-empresa">0</span>
                                    <span class="label">Fora da Empresa</span>
                                </div>
                                <div class="sub-value">
                                    <span class="value" id="dashboard-ponto-cracha-sim">0</span>
                                    <span class="label">Com Crachá</span>
                                </div>
                                <div class="sub-value">
                                    <span class="value" id="dashboard-ponto-cracha-nao">0</span>
                                    <span class="label">Sem Crachá</span>
                                </div>
                            </div>
                        </div>

                        <div class="dashboard-terminal-card">
                            <div class="title"><i class="fa-solid fa-terminal me-2"></i>Logs do Sistema</div>
                            <ul id="recent-logs-list" class="terminal-log-list"></ul>
                            <div class="d-flex justify-content-end mt-2">
                                <button class="btn btn-sm btn-outline-secondary" onclick="exportarLogs()">Exportar Logs</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dashboard-chart-container mt-4">
                        <h5 class="text-center mb-3">Movimentação Diária (Hoje)</h5>
                        <div class="chart-container"><canvas id="dailyMovementChart"></canvas></div>
                    </div>

                    <div class="dashboard-chart-container mt-4">
                        <h5 class="text-center mb-3">Tempo de Permanência (Frota)</h5>
                        <div class="chart-container"><canvas id="tempoPermanenciaChart"></canvas></div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="ponto">
                <div class="table-container glassmorphism">
                    <div class="table-header-sticky glassmorphism">
                        <div class="search-row">
                            <div class="search-container">
                                <input type="text" id="ponto-search" class="search-input" placeholder="Pesquisar...">
                            </div>
                            <div class="info-container">
                                <span id="ponto-na-empresa">Na Empresa: 0</span>
                                <span id="ponto-fora-empresa">Fora da Empresa: 0</span>
                                <span id="ponto-cracha-sim">Com Crachá: 0</span>
                                <span id="ponto-cracha-nao">Sem Crachá: 0</span>
                            </div>
                        </div>
                    </div>
                    <table class="list-table" id="lista-ponto">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Colaborador</th>
                                <th>Entrada</th>
                                <th>Saída</th>
                                <th>Crachá</th>
                                <th>Obs</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="fixed-bottom-form glassmorphism">
                    <div class="row g-1 align-items-center justify-content-center" id="form-ponto">
                        <div class="col-md-auto">
                            <input type="date" id="ponto-data" class="form-control" placeholder="Data">
                        </div>
                        <div class="col-md-auto">
                            <select id="ponto-colaborador" class="form-select"></select>
                        </div>
                        <div class="col-md-auto">
                            <input type="time" id="ponto-entrada" class="form-control" placeholder="Entrada">
                        </div>
                        <div class="col-md-auto">
                            <input type="time" id="ponto-saida" class="form-control" placeholder="Saída">
                        </div>
                        <div class="col-md-auto">
                            <select id="ponto-cracha" class="form-select">
                                <option>Sim</option>
                                <option>Não</option>
                            </select>
                        </div>
                        <div class="col-md-auto">
                            <input type="text" id="ponto-obs" class="form-control" placeholder="Obs">
                        </div>
                        <div class="col-md-auto">
                            <button class="btn btn-icon" onclick="salvar('ponto')"><i class="fa-solid fa-floppy-disk"></i></button>
                        </div>
                        <div class="col-md-auto">
                            <button class="btn btn-icon" id="editar-btn-ponto" disabled onclick="confirmarEdicao('ponto')"><i class="fa-solid fa-pencil"></i></button>
                        </div>
                        <div class="col-md-auto">
                            <button class="btn btn-icon" id="excluir-btn-ponto" disabled onclick="confirmarExclusao('ponto')"><i class="fa-solid fa-trash"></i></button>
                        </div>
                        <div class="col-md-auto">
                            <button class="btn btn-icon" onclick="exportarRelatorioCompleto()"><i class="fa-solid fa-download"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="entregas">
                <div class="table-container glassmorphism">
                    <div class="table-header-sticky glassmorphism">
                        <div class="search-row">
                            <div class="search-container">
                                <input type="text" id="entregas-search" class="search-input" placeholder="Pesquisar...">
                            </div>
                            <div class="info-container">
                                <span id="entregas-total">Veículos no Pátio: 0</span>
                            </div>
                        </div>
                    </div>
                    <table class="list-table" id="lista-entregas">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Motorista</th>
                                <th>Frota</th>
                                <th>Chegada</th>
                                <th>Saída</th>
                                <th>Obs</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="fixed-bottom-form glassmorphism">
                    <div class="row g-1 align-items-center justify-content-center" id="form-entregas">
                        <div class="col-md-auto">
                            <input type="date" id="entregas-data" class="form-control" placeholder="Data">
                        </div>
                        <div class="col-md-auto">
                            <input type="text" id="entregas-motorista" class="form-control" placeholder="Motorista">
                        </div>
                        <div class="col-md-auto">
                            <input type="text" id="entregas-frota" class="form-control" placeholder="Frota">
                        </div>
                        <div class="col-md-auto">
                            <input type="time" id="entregas-chegada" class="form-control" placeholder="Chegada">
                        </div>
                        <div class="col-md-auto">
                            <input type="time" id="entregas-saida" class="form-control" placeholder="Saída">
                        </div>
                        <div class="col-md-auto">
                            <input type="text" id="entregas-obs" class="form-control" placeholder="Obs">
                        </div>
                        <div class="col-md-auto">
                            <button class="btn btn-icon" onclick="salvar('entregas')"><i class="fa-solid fa-floppy-disk"></i></button>
                        </div>
                        <div class="col-md-auto">
                            <button class="btn btn-icon" id="editar-btn-entregas" disabled onclick="confirmarEdicao('entregas')"><i class="fa-solid fa-pencil"></i></button>
                        </div>
                        <div class="col-md-auto">
                            <button class="btn btn-icon" id="excluir-btn-entregas" disabled onclick="confirmarExclusao('entregas')"><i class="fa-solid fa-trash"></i></button>
                        </div>
                        <div class="col-md-auto">
                            <button class="btn btn-icon" onclick="exportarRelatorioCompleto()"><i class="fa-solid fa-download"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="descargas">
                <div class="table-container glassmorphism">
                    <div class="table-header-sticky glassmorphism">
                        <div class="search-row">
                            <div class="search-container">
                                <input type="text" id="descargas-search" class="search-input" placeholder="Pesquisar...">
                            </div>
                            <div></div>
                        </div>
                    </div>
                    <table class="list-table" id="lista-descargas">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Hora</th>
                                <th>Nome</th>
                                <th>CPF</th>
                                <th>Celular</th>
                                <th>Placa CV</th>
                                <th>Placa RB</th>
                                <th>Transp.</th>
                                <th>Fornecedor</th>
                                <th>NF / SH</th>
                                <th>Quantidade</th>
                                <th>Tipo</th>
                                <th>Obs</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="fixed-bottom-form glassmorphism">
                    <div class="row g-1 align-items-center justify-content-center" id="form-descargas">
                        <div class="col-md-auto">
                            <input type="date" id="descargas-data" class="form-control" placeholder="Data">
                        </div>
                        <div class="col-md-auto">
                            <input type="time" id="descargas-hora" class="form-control" placeholder="Hora">
                        </div>
                        <div class="col-md-auto">
                            <input type="text" id="descargas-nome" class="form-control" placeholder="Nome">
                        </div>
                        <div class="col-md-auto">
                            <input type="text" id="descargas-cpf" class="form-control" placeholder="CPF">
                        </div>
                        <div class="col-md-auto">
                            <input type="text" id="descargas-celular" class="form-control" placeholder="Celular">
                        </div>
                        <div class="col-md-auto">
                            <input type="text" id="descargas-placacv" class="form-control" placeholder="Placa CV">
                        </div>
                        <div class="col-md-auto">
                            <input type="text" id="descargas-placarb" class="form-control" placeholder="Placa RB">
                        </div>
                        <div class="col-md-auto">
                            <input type="text" id="descargas-transp" class="form-control" placeholder="Transp.">
                        </div>
                        <div class="col-md-auto">
                            <input type="text" id="descargas-fornecedor" class="form-control" placeholder="Fornecedor">
                        </div>
                        <div class="col-md-auto">
                            <input type="text" id="descargas-nfsh" class="form-control" placeholder="NF / SH">
                        </div>
                        <div class="col-md-auto">
                            <input type="number" id="descargas-quantidade" class="form-control" placeholder="Quantidade">
                        </div>
                        <div class="col-md-auto">
                            <select id="descargas-tipo" class="form-select">
                                <option value="">Tipo</option>
                                <option>Paletizada</option>
                                <option>Batida</option>
                                <option>Volumosa</option>
                            </select>
                        </div>
                        <div class="col-md-auto">
                            <input type="text" id="descargas-obs" class="form-control" placeholder="Obs">
                        </div>
                        <div class="col-md-auto">
                            <button class="btn btn-icon" onclick="salvar('descargas')"><i class="fa-solid fa-floppy-disk"></i></button>
                        </div>
                        <div class="col-md-auto">
                            <button class="btn btn-icon" id="editar-btn-descargas" disabled onclick="confirmarEdicao('descargas')"><i class="fa-solid fa-pencil"></i></button>
                        </div>
                        <div class="col-md-auto">
                            <button class="btn btn-icon" id="excluir-btn-descargas" disabled onclick="confirmarExclusao('descargas')"><i class="fa-solid fa-trash"></i></button>
                        </div>
                        <div class="col-md-auto">
                            <button class="btn btn-icon" onclick="exportarRelatorioCompleto()"><i class="fa-solid fa-download"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="cargas">
                <div class="table-container glassmorphism">
                    <div class="table-header-sticky glassmorphism">
                        <div class="search-row">
                            <div class="search-container">
                                <input type="text" id="cargas-search" class="search-input" placeholder="Pesquisar...">
                            </div>
                            <div></div>
                        </div>
                    </div>
                    <table class="list-table" id="lista-cargas">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Entrada</th>
                                <th>Motorista</th>
                                <th>Doc</th>
                                <th>Contato</th>
                                <th>Cliente</th>
                                <th>Placas</th>
                                <th>Autorização</th>
                                <th>Obs</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="fixed-bottom-form glassmorphism">
                    <div class="row g-1 align-items-center justify-content-center" id="form-cargas">
                        <div class="col-md-auto">
                            <input type="date" id="cargas-data" class="form-control" placeholder="Data">
                        </div>
                        <div class="col-md-auto">
                            <input type="time" id="cargas-entrada" class="form-control" placeholder="Entrada">
                        </div>
                        <div class="col-md-auto">
                            <input type="text" id="cargas-motorista" class="form-control" placeholder="Motorista">
                        </div>
                        <div class="col-md-auto">
                            <input type="text" id="cargas-doc" class="form-control" placeholder="Doc">
                        </div>
                        <div class="col-md-auto">
                            <input type="text" id="cargas-contato" class="form-control" placeholder="Contato">
                        </div>
                        <div class="col-md-auto">
                            <input type="text" id="cargas-cliente" class="form-control" placeholder="Cliente">
                        </div>
                        <div class="col-md-auto">
                            <input type="text" id="cargas-placas" class="form-control" placeholder="Placas">
                        </div>
                        <div class="col-md-auto">
                            <input type="text" id="cargas-autorizacao" class="form-control" placeholder="Autorização">
                        </div>
                        <div class="col-md-auto">
                            <input type="text" id="cargas-obs" class="form-control" placeholder="Obs">
                        </div>
                        <div class="col-md-auto">
                            <button class="btn btn-icon" onclick="salvar('cargas')"><i class="fa-solid fa-floppy-disk"></i></button>
                        </div>
                        <div class="col-md-auto">
                            <button class="btn btn-icon" id="editar-btn-cargas" disabled onclick="confirmarEdicao('cargas')"><i class="fa-solid fa-pencil"></i></button>
                        </div>
                        <div class="col-md-auto">
                            <button class="btn btn-icon" id="excluir-btn-cargas" disabled onclick="confirmarExclusao('cargas')"><i class="fa-solid fa-trash"></i></button>
                        </div>
                        <div class="col-md-auto">
                            <button class="btn btn-icon" onclick="exportarRelatorioCompleto()"><i class="fa-solid fa-download"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="outros">
                <div class="table-container glassmorphism">
                    <div class="table-header-sticky glassmorphism">
                        <div class="search-row">
                            <div class="search-container">
                                <input type="text" id="outros-search" class="search-input" placeholder="Pesquisar...">
                            </div>
                            <div></div>
                        </div>
                    </div>
                    <table class="list-table" id="lista-outros">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Hora</th>
                                <th>Nome</th>
                                <th>Doc</th>
                                <th>Empresa</th>
                                <th>Autorização</th>
                                <th>Obs</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="fixed-bottom-form glassmorphism">
                    <div class="row g-1 align-items-center justify-content-center" id="form-outros">
                        <div class="col-md-auto">
                            <input type="date" id="outros-data" class="form-control" placeholder="Data">
                        </div>
                        <div class="col-md-auto">
                            <input type="time" id="outros-hora" class="form-control" placeholder="Hora">
                        </div>
                        <div class="col-md-auto">
                            <input type="text" id="outros-nome" class="form-control" placeholder="Nome">
                        </div>
                        <div class="col-md-auto">
                            <input type="text" id="outros-doc" class="form-control" placeholder="Doc">
                        </div>
                        <div class="col-md-auto">
                            <input type="text" id="outros-empresa" class="form-control" placeholder="Empresa">
                        </div>
                        <div class="col-md-auto">
                            <input type="text" id="outros-autorizacao" class="form-control" placeholder="Autorização">
                        </div>
                        <div class="col-md-auto">
                            <input type="text" id="outros-obs" class="form-control" placeholder="Obs">
                        </div>
                        <div class="col-md-auto">
                            <button class="btn btn-icon" onclick="salvar('outros')"><i class="fa-solid fa-floppy-disk"></i></button>
                        </div>
                        <div class="col-md-auto">
                            <button class="btn btn-icon" id="editar-btn-outros" disabled onclick="confirmarEdicao('outros')"><i class="fa-solid fa-pencil"></i></button>
                        </div>
                        <div class="col-md-auto">
                            <button class="btn btn-icon" id="excluir-btn-outros" disabled onclick="confirmarExclusao('outros')"><i class="fa-solid fa-trash"></i></button>
                        </div>
                        <div class="col-md-auto">
                            <button class="btn btn-icon" onclick="exportarRelatorioCompleto()"><i class="fa-solid fa-download"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="sistema">
                <div class="container glassmorphism p-4 mt-3 sistema-container">
                    <h3 class="mb-4 text-center">Gerenciamento de Sistema</h3>
                    <div class="d-grid gap-2 col-6 mx-auto">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#userModal"><i class="fa-solid fa-user-plus me-2"></i> Novo Usuário</button>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="sobre">
                <div class="container glassmorphism p-4 mt-3">
                    <h3 class="text-center mb-4">Sobre o Sistema</h3>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5><i class="fa-solid fa-circle-info me-2"></i> Funcionalidades</h5>
                            <ul>
                                <li>Registro de Ponto de Colaboradores (Com filtro de "presentes").</li>
                                <li>Registro de Entrada e Saída de Frotas (Placar em tempo real).</li>
                                <li>Registro de Descargas com informações de motorista, placa e volume.</li>
                                <li>Registro de Cargas com informações de motorista e cliente.</li>
                                <li>Registro de Visitantes e Pessoas Autorizadas.</li>
                                <li>Exportação completa de todos os registros para uma única planilha Excel.</li>
                                <li>Exportação do Dashboard em PDF com gráficos.</li>
                                <li>Automação para exportação diária de relatórios (PDF e XLSX) à meia-noite.</li>
                                <li>Blocos de informações da aba Ponto e logs do sistema no Dashboard.</li>
                                <li>Bloco de logs com estilo de terminal.</li>
                                <li>Gerenciamento de usuários com senha de administrador.</li>
                                <li>Sistema de login com validação de credenciais.</li>
                                <li>Sistema de recuperação de senha por CPF e e-mail.</li>
                                <li>**NOVO:** Login persistente (não precisa logar toda vez).</li>
                                <li>**NOVO:** Botão de deslogar.</li>
                                <li>**NOVO:** Exibe o usuário logado no cabeçalho.</li>
                                <li>**NOVO:** Sistema de logs com exportação por senha mestra.</li>
                                <li>**NOVO:** Logs de Login e Logout.</li>
                                <li>**NOVO:** Tela de Primeiro Acesso para criar o usuário administrador.</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h5><i class="fa-solid fa-laptop-code me-2"></i> Tecnologias Utilizadas</h5>
                            <ul>
                                <li><strong>HTML5:</strong> Estrutura da página.</li>
                                <li><strong>CSS3:</strong> Estilização, incluindo modo escuro e efeito glassmorphism.</li>
                                <li><strong>JavaScript (ES6+):</strong> Lógica de programação e manipulação do DOM.</li>
                                <li><strong>Bootstrap 5:</strong> Componentes e layout responsivo.</li>
                                <li><strong>Chart.js:</strong> Para a criação dos gráficos do dashboard.</li>
                                <li><strong>SheetJS / XLSX:</strong> Para a exportação de dados para planilhas.</li>
                                <li><strong>jsPDF & html2canvas:</strong> Para a exportação do Dashboard em PDF.</li>
                                <li><strong>Font Awesome:</strong> Biblioteca de ícones.</li>
                            </ul>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <h5><i class="fa-solid fa-code-branch me-2"></i> Versão e Desenvolvimento</h5>
                            <p><strong>Versão:</strong> 1.9.4</p>
                            <p><strong>Desenvolvedor:</strong> Gemini - Assistente de IA do Google</p>
                        </div>
                        <div class="col-md-6">
                            <h5><i class="fa-solid fa-exclamation-triangle me-2"></i> Observações</h5>
                            <p>Este sistema foi desenvolvido como uma aplicação web simples, focada em praticidade e uso local. Todos os dados são salvos diretamente no navegador (LocalStorage), sem a necessidade de banco de dados ou conexão com a internet. Por isso, a exportação regular dos dados é recomendada para fins de backup. O agendamento de tarefas diárias depende que o navegador esteja aberto.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalLabel">Cadastrar Novo Usuário</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <div class="mb-3">
                            <label for="userName" class="form-label">Nome Completo</label>
                            <input type="text" class="form-control" id="userName" required>
                        </div>
                        <div class="mb-3">
                            <label for="userCpf" class="form-label">CPF</label>
                            <input type="text" class="form-control" id="userCpf" required>
                        </div>
                        <div class="mb-3">
                            <label for="userCel" class="form-label">Celular</label>
                            <input type="text" class="form-control" id="userCel">
                        </div>
                        <div class="mb-3">
                            <label for="userEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="userEmail">
                        </div>
                        <div class="mb-3">
                            <label for="userUsername" class="form-label">Usuário</label>
                            <input type="text" class="form-control" id="userUsername" required>
                        </div>
                        <div class="mb-3">
                            <label for="userPassword" class="form-label">Senha</label>
                            <input type="password" class="form-control" id="userPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="userConfirmPassword" class="form-label">Confirmar Senha</label>
                            <input type="password" class="form-control" id="userConfirmPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="adminPasswordUserModal" class="form-label">Senha do Administrador</label>
                            <input type="password" class="form-control" id="adminPasswordUserModal" required>
                            <div class="invalid-feedback" id="adminPasswordFeedback"></div>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">Salvar Usuário</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Confirmação</h5></div>
                <div class="modal-body" id="confirmModalBody"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmAction">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container">
        <div class="toast align-items-center" role="alert" aria-live="assertive" aria-atomic="true" id="myToast">
            <div class="d-flex">
                <div class="toast-body" id="toast-message"></div>
                <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <div id="hidden-pdf-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        let itemSelecionado = null;
        let confirmModal = null;
        let userModal = null;
        let myToast = null;
        let masterPasswordModal = null;
        const MASTER_PASSWORD = "8080Ipmask@root";
        let currentUser = null;

        const headersMap = {
            'ponto': ['data', 'colaborador', 'entrada', 'saida', 'cracha', 'obs'],
            'entregas': ['data', 'motorista', 'frota', 'chegada', 'saida', 'obs'],
            'descargas': ['data', 'hora', 'nome', 'cpf', 'celular', 'placacv', 'placarb', 'transp', 'fornecedor', 'nfsh', 'quantidade', 'tipo', 'obs'],
            'cargas': ['data', 'entrada', 'motorista', 'doc', 'contato', 'cliente', 'placas', 'autorizacao', 'obs'],
            'outros': ['data', 'hora', 'nome', 'doc', 'empresa', 'autorizacao', 'obs']
        };

        const masterColaboradores = [
            "Leandro S.", "Oscar -Supervisor", "João Paulo - Menor Aprendiz", "Vitória Isabele", 
            "Thalles", "André", "Ezequias", "Luiz Carlos", "Raimundo", "Michel F. - Menor Aprendiz",
            "João Vitor", "Luiz Henrique", "Cristiano", "Marsergio-Gerente", "André - ADM", 
            "Jean Carlos", "Enildo -Supervisor", "Thiago Benjamin", "Jayme - Encarregado - Van", 
            "Raimundo - Van", "Marcos - Van", "Fábio - Van", "Eriton - Van", "Elionai - Van",
            "Edmar - Van", "Jefferson - Van", "Wanderson", "Kleverson", "Leandro F.", 
            "Gilliard D.", "Leandro P.", "André F.", "Leonardo", "Dangel – Menor aprendiz", 
            "Cauan – Menor aprendiz", "Nicolas G – Menor aprendiz", "Elias – Menor aprendiz", 
            "Murilo - Menor Aprendiz", "Matias - Menor Aprendiz", "Yuri - Menor Aprendiz", 
            "Pedro H - Menor Aprendiz", "Felipe - Menor Aprendiz", "Abraão - Menor Aprendiz", 
            "Gabriel - Menor Aprendiz", "Edirlei - CPD"
        ];
        
        const today = new Date().toISOString().split('T')[0];
        const chartInstances = {};

        document.addEventListener('DOMContentLoaded', () => {
            confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
            userModal = new bootstrap.Modal(document.getElementById('userModal'));
            masterPasswordModal = new bootstrap.Modal(document.getElementById('masterPasswordModal'));
            myToast = new bootstrap.Toast(document.getElementById('myToast'));

            checkFirstAccess();
            
            document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
            agendarTarefasDiarias();
            document.getElementById('userForm').addEventListener('submit', salvarUsuario);
            document.getElementById('loginForm').addEventListener('submit', login);
            document.getElementById('recoverForm').addEventListener('submit', recuperarSenha);
            document.getElementById('firstAccessForm').addEventListener('submit', cadastrarPrimeiroUsuario);

            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('shown.bs.tab', (e) => {
                    const abaId = e.target.getAttribute('href').substring(1);
                    if (abaId === 'ponto') {
                        renderColaboradoresPonto();
                    } else if (abaId === 'dashboard') {
                        renderDashboard(today);
                    }
                    reiniciarBotoes(abaId);
                    limparCampos(abaId);
                });
            });
            document.getElementById('ponto-search').addEventListener('input', (e) => render('ponto', e.target.value));
            document.getElementById('entregas-search').addEventListener('input', (e) => render('entregas', e.target.value));
            document.getElementById('descargas-search').addEventListener('input', (e) => render('descargas', e.target.value));
            document.getElementById('cargas-search').addEventListener('input', (e) => render('cargas', e.target.value));
            document.getElementById('outros-search').addEventListener('input', (e) => render('outros', e.target.value));
        });
        
        function showToast(message) {
            document.getElementById('toast-message').textContent = message;
            myToast.show();
        }

        function checkFirstAccess() {
            const usuarios = getUsuarios();
            if (usuarios.length === 0) {
                document.getElementById('firstAccessModal').style.display = 'flex';
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('systemContent').style.display = 'none';
            } else {
                checkSession();
            }
        }
        
        function cadastrarPrimeiroUsuario(event) {
            event.preventDefault();
            const form = event.target;
            const nome = form.adminName.value;
            const usuario = form.adminUsername.value;
            const senha = form.adminPassword.value;
            const confirmarSenha = form.adminConfirmPassword.value;
            const feedback = document.getElementById('firstAccessFeedback');

            if (senha !== confirmarSenha) {
                feedback.textContent = "As senhas não coincidem.";
                return;
            }
            if (senha.length < 6) {
                feedback.textContent = "A senha deve ter no mínimo 6 caracteres.";
                return;
            }

            const novoUsuario = {
                nome,
                usuario,
                senha: btoa(senha),
                is_admin: true,
                cpf: null,
                cel: null,
                email: null
            };
            
            localStorage.setItem('usuarios', JSON.stringify([novoUsuario]));
            showToast("Usuário administrador criado com sucesso! Por favor, faça o login.");
            addLog('Criação do Primeiro Usuário', { usuario: novoUsuario.usuario });
            
            document.getElementById('firstAccessModal').style.display = 'none';
            showLoginModal();
        }

        function getUsuarios() {
            try {
                return JSON.parse(localStorage.getItem('usuarios') || '[]');
            } catch (e) {
                console.error('Erro ao carregar usuários:', e);
                return [];
            }
        }
        
        function checkSession() {
            const loggedInUser = localStorage.getItem('loggedInUser');
            if (loggedInUser) {
                currentUser = JSON.parse(loggedInUser);
                startSession();
            } else {
                showLoginModal();
            }
        }
        
        function startSession() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('systemContent').style.display = 'block';
            document.getElementById('userNameDisplay').textContent = `Bem-vindo, ${currentUser.nome.split(' ')[0]}`;
            
            render('ponto');
            render('entregas');
            render('descargas');
            render('cargas');
            render('outros');
            renderDashboard(today);
        }

        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'flex';
            document.getElementById('recoverPasswordModal').style.display = 'none';
        }

        function showRecoverPasswordModal() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('recoverPasswordModal').style.display = 'flex';
        }

        function login(event) {
            event.preventDefault();
            const usuario = document.getElementById('loginUsername').value;
            const senha = document.getElementById('loginPassword').value;
            const feedback = document.getElementById('loginFeedback');
            
            const usuarios = getUsuarios();
            const usuarioEncontrado = usuarios.find(u => u.usuario === usuario && atob(u.senha) === senha);
            
            if (usuarioEncontrado) {
                currentUser = usuarioEncontrado;
                localStorage.setItem('loggedInUser', JSON.stringify(currentUser));
                addLog('Login', { usuario: currentUser.usuario, nome: currentUser.nome });
                showToast("Login bem-sucedido!");
                startSession();
            } else {
                feedback.textContent = 'Usuário ou senha incorretos.';
                feedback.style.color = 'red';
            }
        }
        
        function logout() {
            if (currentUser) {
                addLog('Logout', { usuario: currentUser.usuario, nome: currentUser.nome });
            }
            localStorage.removeItem('loggedInUser');
            currentUser = null;
            document.getElementById('systemContent').style.display = 'none';
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginFeedback').textContent = '';
            showLoginModal();
            showToast("Você foi desconectado.");
        }
        
        function recuperarSenha(event) {
            event.preventDefault();
            const cpf = document.getElementById('recoverCpf').value;
            const email = document.getElementById('recoverEmail').value;
            const feedback = document.getElementById('recoverFeedback');
            
            const usuarios = getUsuarios();
            const usuarioEncontrado = usuarios.find(u => u.cpf === cpf && u.email === email);
            
            if (usuarioEncontrado) {
                const novaSenha = Math.random().toString(36).substring(2, 10);
                usuarioEncontrado.senha = btoa(novaSenha);
                localStorage.setItem('usuarios', JSON.stringify(usuarios));
                addLog('Recuperação de Senha', { usuario: usuarioEncontrado.usuario, nome: usuarioEncontrado.nome });
                feedback.innerHTML = `Sua nova senha é: <br><strong>${novaSenha}</strong>. Anote e volte para a tela de login.`;
                feedback.style.color = 'green';
            } else {
                feedback.textContent = 'CPF e/ou e-mail não encontrados.';
                feedback.style.color = 'red';
            }
        }

        function getDadosAba(aba) {
            try {
                return JSON.parse(localStorage.getItem(aba) || '[]');
            } catch (e) {
                console.error(`Erro ao carregar dados da aba '${aba}':`, e);
                return [];
            }
        }

        function getLogs() {
            try {
                return JSON.parse(localStorage.getItem('logs') || '[]');
            } catch (e) {
                console.error('Erro ao carregar logs:', e);
                return [];
            }
        }

        function addLog(action, details) {
            const logs = getLogs();
            const now = new Date();
            const logEntry = {
                timestamp: now.toISOString(),
                user: currentUser ? currentUser.usuario : 'Desconhecido',
                action,
                details
            };
            logs.push(logEntry);
            localStorage.setItem('logs', JSON.stringify(logs));
        }
        
        function salvar(aba) {
            const inputs = document.querySelectorAll(`#form-${aba} input, #form-${aba} select`);
            const dados = {};
            inputs.forEach(inp => {
                const key = inp.id.split('-')[1];
                dados[key] = inp.value;
            });
            if (!dados.data || (headersMap[aba].includes('hora') && !dados.hora) || (headersMap[aba].includes('chegada') && !dados.chegada) || (headersMap[aba].includes('entrada') && !dados.entrada)) {
                showToast("Por favor, preencha os campos obrigatórios.");
                return;
            }
            let lista = getDadosAba(aba);
            
            if (itemSelecionado && itemSelecionado.aba === aba && itemSelecionado.index !== null) {
                const oldData = lista[itemSelecionado.index];
                lista[itemSelecionado.index] = dados;
                addLog('Edição', { aba, oldData, newData: dados });
                showToast("Item editado com sucesso!");
            } else {
                lista.push(dados);
                addLog('Inserção', { aba, newData: dados });
                showToast("Item salvo com sucesso!");
            }
            lista = ordenarDadosPorDataEHora(lista, aba);
            localStorage.setItem(aba, JSON.stringify(lista));
            render(aba);
            limparCampos(aba);
            const tableContainer = document.querySelector(`#${aba} .table-container`);
            tableContainer.scrollTo({ top: tableContainer.scrollHeight, behavior: 'smooth' });
            renderDashboard(today);
            if (aba === 'ponto') {
                 renderColaboradoresPonto();
            }
        }

        function render(aba, filtro = '') {
            const listaOriginal = getDadosAba(aba);
            const tbody = document.querySelector(`#lista-${aba} tbody`);
            if (!tbody) return;
            tbody.innerHTML = '';
            
            const listaFiltrada = listaOriginal.filter(item => {
                if (!filtro) return true;
                const filtroLowerCase = filtro.toLowerCase();
                return Object.values(item).some(value => 
                    value && value.toString().toLowerCase().includes(filtroLowerCase)
                );
            });
            
            listaFiltrada.forEach(item => {
                const tr = document.createElement('tr');
                const originalIndex = listaOriginal.findIndex(origItem => JSON.stringify(origItem) === JSON.stringify(item));
                tr.onclick = () => selecionarItem(tr, aba, originalIndex);
                
                const itemKeys = headersMap[aba];
                itemKeys.forEach(key => {
                    const td = document.createElement('td');
                    td.textContent = item[key] || '';
                    if (aba === 'entregas' && key === 'frota') {
                        if (item.chegada && !item.saida) {
                            const chegada = new Date(`${item.data}T${item.chegada}`);
                            const agora = new Date();
                            const diffMs = agora - chegada;
                            const diffHoras = diffMs / (1000 * 60 * 60);
                            if (diffHoras > 2) { 
                                tr.classList.add('frota-status-warning');
                            }
                        }
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            atualizarContadores(aba, listaOriginal);
            reiniciarBotoes(aba);
        }
        
        function atualizarContadores(aba, lista) {
            if (aba === 'ponto') {
                const registrosDoDia = lista.filter(item => item.data === today);
                const presentes = registrosDoDia.filter(item => item.entrada && !item.saida).length;
                const crachaSim = registrosDoDia.filter(item => item.cracha === 'Sim').length;
                const crachaNao = registrosDoDia.filter(item => item.cracha === 'Não').length;
                const totalColaboradores = masterColaboradores.length;

                document.getElementById('ponto-na-empresa').textContent = `Na Empresa: ${presentes}`;
                document.getElementById('ponto-fora-empresa').textContent = `Fora da Empresa: ${totalColaboradores - presentes}`;
                document.getElementById('ponto-cracha-sim').textContent = `Com Crachá: ${crachaSim}`;
                document.getElementById('ponto-cracha-nao').textContent = `Sem Crachá: ${crachaNao}`;

                renderColaboradoresPonto();
            } else if (aba === 'entregas') {
                const noPatio = lista.filter(item => item.chegada && !item.saida).length;
                const entregasTotalElement = document.getElementById('entregas-total');
                if (entregasTotalElement) entregasTotalElement.textContent = `Veículos no Pátio: ${noPatio}`;
            }
        }
        
        function renderColaboradoresPonto() {
            const select = document.getElementById('ponto-colaborador');
            if (!select) return;
            const listaPonto = getDadosAba('ponto');
            const ativos = listaPonto.filter(item => item.entrada && !item.saida).map(item => item.colaborador);
            select.innerHTML = '';
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Selecione';
            select.appendChild(defaultOption);
            masterColaboradores.forEach(nome => {
                const option = document.createElement('option');
                option.textContent = nome;
                option.value = nome;
                if (ativos.includes(nome)) {
                    option.disabled = true;
                }
                select.appendChild(option);
            });
        }

        function selecionarItem(tr, aba, index) {
            const tabela = document.querySelector(`#lista-${aba}`);
            if (!tabela) return;
            const todasTr = tabela.querySelectorAll('tr');
            todasTr.forEach(row => row.classList.remove('selected'));
            tr.classList.add('selected');
            itemSelecionado = { aba, index };
            const lista = getDadosAba(aba);
            const item = lista[index];
            preencherCampos(aba, item);
            const editarBtn = document.getElementById(`editar-btn-${aba}`);
            const excluirBtn = document.getElementById(`excluir-btn-${aba}`);
            editarBtn.disabled = false;
            excluirBtn.disabled = false;
        }

        function preencherCampos(aba, item) {
            const inputs = document.querySelectorAll(`#form-${aba} input, #form-${aba} select`);
            inputs.forEach(inp => {
                const key = inp.id.split('-')[1];
                if (item[key] !== undefined) {
                    inp.value = item[key];
                }
            });
        }

        function confirmarEdicao(aba) {
            if (itemSelecionado) {
                document.getElementById('confirmModalBody').textContent = "Deseja editar este item?";
                document.getElementById('confirmAction').className = 'btn btn-info';
                document.getElementById('confirmAction').textContent = 'Editar';
                document.getElementById('confirmAction').onclick = () => {
                    salvar(aba);
                    confirmModal.hide();
                };
                confirmModal.show();
            }
        }

        function confirmarExclusao(aba) {
            if (itemSelecionado) {
                document.getElementById('confirmModalBody').textContent = "Deseja excluir este item?";
                document.getElementById('confirmAction').className = 'btn btn-danger';
                document.getElementById('confirmAction').textContent = 'Excluir';
                document.getElementById('confirmAction').onclick = () => {
                    excluirItem(aba, itemSelecionado.index);
                    confirmModal.hide();
                };
                confirmModal.show();
            }
        }

        function excluirItem(aba, index) {
            const lista = getDadosAba(aba);
            const deletedItem = lista.splice(index, 1);
            localStorage.setItem(aba, JSON.stringify(lista));
            addLog('Exclusão', { aba, deletedData: deletedItem[0] });
            render(aba);
            limparCampos(aba);
            renderDashboard(today);
            showToast("Item excluído com sucesso!");
        }

        function reiniciarBotoes(aba) {
            const editarBtn = document.getElementById(`editar-btn-${aba}`);
            const excluirBtn = document.getElementById(`excluir-btn-${aba}`);
            if (editarBtn) editarBtn.disabled = true;
            if (excluirBtn) excluirBtn.disabled = true;
            itemSelecionado = null;
        }

        function limparCampos(aba) {
            const inputs = document.querySelectorAll(`#form-${aba} input, #form-${aba} select`);
            inputs.forEach(inp => {
                if (inp.type === 'date' || inp.type === 'time' || inp.type === 'text' || inp.type === 'number' || inp.type === 'email') {
                    inp.value = '';
                } else if (inp.tagName === 'SELECT' && inp.id.includes('colaborador')) {
                    inp.selectedIndex = 0;
                }
            });
        }
        
        function ordenarDadosPorDataEHora(lista, aba) {
            const camposDeData = {
                'ponto': 'data', 'entregas': 'data', 'descargas': 'data', 'cargas': 'data', 'outros': 'data'
            };
            const camposDeHora = {
                'ponto': 'entrada', 'entregas': 'chegada', 'descargas': 'hora', 'cargas': 'entrada', 'outros': 'hora'
            };
            const campoData = camposDeData[aba];
            const campoHora = camposDeHora[aba];
            lista.sort((a, b) => {
                const dataA = a[campoData];
                const horaA = a[campoHora] || '00:00';
                const dataB = b[campoData];
                const horaB = b[campoHora] || '00:00';
                const dateTimeA = new Date(`${dataA}T${horaA}`);
                const dateTimeB = new Date(`${dataB}T${horaB}`);
                return dateTimeA - dateTimeB;
            });
            return lista;
        }

        function exportarRelatorioCompleto() {
            const wb = XLSX.utils.book_new();
            const abas = ['ponto', 'entregas', 'descargas', 'cargas', 'outros'];
            abas.forEach(aba => {
                const data = getDadosAba(aba);
                const headers = headersMap[aba];
                const dataWithHeaders = data.map(item => {
                    const newObject = {};
                    for (const key of headers) {
                        newObject[key] = item[key];
                    }
                    return newObject;
                });
                if (dataWithHeaders.length > 0) {
                    const ws = XLSX.utils.json_to_sheet(dataWithHeaders);
                    XLSX.utils.book_append_sheet(wb, ws, aba.charAt(0).toUpperCase() + aba.slice(1));
                }
            });
            if (wb.SheetNames.length === 0) {
                showToast("Não há dados em nenhuma seção para exportar.");
                return;
            }
            const dataHora = new Date();
            const dataFormatada = `${dataHora.getFullYear()}-${(dataHora.getMonth() + 1).toString().padStart(2, '0')}-${dataHora.getDate().toString().padStart(2, '0')}_${dataHora.getHours().toString().padStart(2, '0')}-${dataHora.getMinutes().toString().padStart(2, '0')}`;
            const filename = `biz_movimentacao_${dataFormatada}.xlsx`;
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            saveAs(new Blob([wbout], { type: 'application/octet-stream' }), filename);
        }

        function agendarTarefasDiarias() {
            const agora = new Date();
            const meiaNoite = new Date(agora);
            meiaNoite.setDate(agora.getDate() + 1);
            meiaNoite.setHours(0, 0, 0, 0);
            const tempoParaMeiaNoite = meiaNoite.getTime() - agora.getTime();
            setTimeout(() => {
                executarTarefasDiarias();
                agendarTarefasDiarias();
            }, tempoParaMeiaNoite);
        }

        function executarTarefasDiarias() {
            showToast("Iniciando a emissão automática de relatórios...");
            exportarRelatorioCompleto();
            gerarRelatorioPDFDiario();
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const icon = document.getElementById('darkModeToggle').querySelector('i');
            if (document.body.classList.contains('dark-mode')) {
                icon.className = 'fa-solid fa-sun';
            } else {
                icon.className = 'fa-solid fa-moon';
            }
            renderDashboard(today);
        }

        function updateDashboardCards(dataEntregas, dataDescargas, dataCargas, dataHoje) {
            const frotasEntraram = dataEntregas.filter(item => item.data === dataHoje && item.chegada).length;
            const frotasSairam = dataEntregas.filter(item => item.data === dataHoje && item.saida).length;
            const frotasPatio = dataEntregas.filter(item => item.chegada && !item.saida).length;

            document.getElementById('dashboard-frotas-entraram').textContent = frotasEntraram;
            document.getElementById('dashboard-frotas-sairam').textContent = frotasSairam;
            document.getElementById('dashboard-frotas-patio').textContent = frotasPatio;

            const permanencias = dataEntregas.filter(item => item.data === dataHoje && item.chegada && item.saida).map(item => {
                const chegada = new Date(`${item.data}T${item.chegada}`);
                const saida = new Date(`${item.data}T${item.saida}`);
                const diffMs = saida - chegada;
                return diffMs / (1000 * 60); 
            });
            const mediaPermanenciaMin = permanencias.length > 0 ? permanencias.reduce((sum, val) => sum + val, 0) / permanencias.length : 0;
            const mediaHoras = Math.floor(mediaPermanenciaMin / 60);
            const mediaMinutos = Math.round(mediaPermanenciaMin % 60);
            const mediaPermanenciaElement = document.getElementById('dashboard-media-permanencia');
            mediaPermanenciaElement.textContent = `${mediaHoras}h ${mediaMinutos}m`;
            
            if (mediaHoras > 2) {
                mediaPermanenciaElement.classList.add('warning');
            } else {
                mediaPermanenciaElement.classList.remove('warning');
            }

            const descargasHoje = dataDescargas.filter(item => item.data === dataHoje).length;
            document.getElementById('dashboard-descargas-hoje').textContent = descargasHoje;

            const cargasHoje = dataCargas.filter(item => item.data === dataHoje).length;
            document.getElementById('dashboard-cargas-hoje').textContent = cargasHoje;
        }

        function updateDashboardPontoCounters(dataPonto) {
            const registrosDoDia = dataPonto.filter(item => item.data === today);
            const presentes = registrosDoDia.filter(item => item.entrada && !item.saida).length;
            const crachaSim = registrosDoDia.filter(item => item.cracha === 'Sim').length;
            const crachaNao = registrosDoDia.filter(item => item.cracha === 'Não').length;
            const totalColaboradores = masterColaboradores.length;

            document.getElementById('dashboard-ponto-na-empresa').textContent = presentes;
            document.getElementById('dashboard-ponto-fora-empresa').textContent = totalColaboradores - presentes;
            document.getElementById('dashboard-ponto-cracha-sim').textContent = crachaSim;
            document.getElementById('dashboard-ponto-cracha-nao').textContent = crachaNao;
        }

        function renderRecentActivity() {
            const allLogs = getLogs();
            allLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            const recentLogs = allLogs.slice(0, 5);

            const listElement = document.getElementById('recent-logs-list');
            listElement.innerHTML = '';
            
            if (recentLogs.length === 0) {
                const li = document.createElement('li');
                li.textContent = 'Nenhum registro recente.';
                listElement.appendChild(li);
                return;
            }

            recentLogs.forEach(log => {
                const li = document.createElement('li');
                const logDate = new Date(log.timestamp);
                const logTime = `${logDate.toLocaleDateString('pt-BR')} ${logDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}`;
                let details = log.details.aba ? `Aba: ${log.details.aba}` : 'N/A';
                if (log.action === 'Login' || log.action === 'Logout') {
                    details = `Usuário: ${log.details.usuario}`;
                }
                li.textContent = `${logTime} - Usuário: ${log.user} - Ação: ${log.action} - Detalhes: ${details}`;
                listElement.appendChild(li);
            });
        }

        function renderDailyMovementChart(dataEntregas, dataCargas, dataDescargas, dataHoje, container) {
            destroyChart('dailyMovementChart');
            const entregasData = [dataEntregas.filter(item => item.data === dataHoje).length];
            const cargasData = [dataCargas.filter(item => item.data === dataHoje).length];
            const descargasData = [dataDescargas.filter(item => item.data === dataHoje).length];
            
            const ctx = container.querySelector('#dailyMovementChart').getContext('2d');
            chartInstances.dailyMovementChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [dataHoje.split('-').reverse().join('/')],
                    datasets: [
                        { label: 'Entregas', data: entregasData, backgroundColor: 'rgba(54, 162, 235, 0.8)' },
                        { label: 'Cargas', data: cargasData, backgroundColor: 'rgba(153, 102, 255, 0.8)' },
                        { label: 'Descargas', data: descargasData, backgroundColor: 'rgba(255, 159, 64, 0.8)' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function renderTempoPermanenciaChart(dataEntregas, dataHoje, container) {
            destroyChart('tempoPermanenciaChart');
            const temposPorFrota = {};
            dataEntregas.filter(item => item.data === dataHoje && item.chegada && item.saida).forEach(item => {
                const frota = item.frota;
                const chegada = new Date(`${item.data}T${item.chegada}`);
                const saida = new Date(`${item.data}T${item.saida}`);
                const diffMs = saida - chegada;
                const diffHoras = (diffMs / (1000 * 60 * 60)).toFixed(2);
                if (!temposPorFrota[frota]) {
                    temposPorFrota[frota] = [];
                }
                temposPorFrota[frota].push(parseFloat(diffHoras));
            });
            const labels = Object.keys(temposPorFrota);
            const medias = labels.map(frota => {
                const tempos = temposPorFrota[frota];
                return (tempos.reduce((sum, val) => sum + val, 0) / tempos.length).toFixed(2);
            });
            
            const ctx = container.querySelector('#tempoPermanenciaChart').getContext('2d');
            chartInstances.tempoPermanenciaChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Média de Permanência (horas)',
                        data: medias,
                        backgroundColor: 'rgba(75, 192, 192, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function renderDashboard(dataTarget) {
            const dataEntregas = getDadosAba('entregas');
            const dataDescargas = getDadosAba('descargas');
            const dataCargas = getDadosAba('cargas');
            const dataPonto = getDadosAba('ponto');

            updateDashboardCards(dataEntregas, dataDescargas, dataCargas, dataTarget);
            updateDashboardPontoCounters(dataPonto);
            renderRecentActivity();
            
            const mainDashboard = document.getElementById('dashboard');
            renderDailyMovementChart(dataEntregas, dataCargas, dataDescargas, dataTarget, mainDashboard);
            renderTempoPermanenciaChart(dataEntregas, dataTarget, mainDashboard);
        }

        function destroyChart(chartId) {
            if (chartInstances[chartId]) {
                chartInstances[chartId].destroy();
                delete chartInstances[chartId];
            }
        }

        async function gerarPDFDoContainer(container, filename) {
            const nav = document.querySelector('.navbar');
            const navDisplay = nav.style.display;
            nav.style.display = 'none';

            const canvas = await html2canvas(container, { scale: 2, logging: false, useCORS: true });
            nav.style.display = navDisplay;
            
            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const imgWidth = 210;
            const pageHeight = 297;
            const imgHeight = canvas.height * imgWidth / canvas.width;
            let heightLeft = imgHeight;
            let position = 0;

            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
            while (heightLeft >= 0) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }
            pdf.save(filename);
        }

        function exportarDashboardPDF() {
            const dashboardElement = document.getElementById('dashboard');
            const today = new Date();
            const filename = `bizdiario_${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}_${today.getHours().toString().padStart(2, '0')}-${today.getMinutes().toString().padStart(2, '0')}.pdf`;
            gerarPDFDoContainer(dashboardElement, filename).then(() => {
                showToast("Relatório PDF exportado com sucesso!");
            });
        }

        async function gerarRelatorioPDFDiario() {
            const dataParaRelatorio = new Date();
            dataParaRelatorio.setDate(dataParaRelatorio.getDate() - 1);
            const dataFormatada = dataParaRelatorio.toISOString().split('T')[0];
            
            const hiddenContainer = document.getElementById('hidden-pdf-container');
            hiddenContainer.innerHTML = document.getElementById('dashboard').innerHTML;
            
            const tituloRelatorio = hiddenContainer.querySelector('h3');
            tituloRelatorio.textContent = `Painel de Monitoramento - Relatório Diário (${dataFormatada.split('-').reverse().join('/')})`;
            
            const dataEntregas = getDadosAba('entregas');
            const dataDescargas = getDadosAba('descargas');
            const dataCargas = getDadosAba('cargas');
            const dataPonto = getDadosAba('ponto');
            updateDashboardCards(dataEntregas, dataDescargas, dataCargas, dataFormatada);
            updateDashboardPontoCounters(dataPonto);
            renderRecentActivity(); 
            renderDailyMovementChart(dataEntregas, dataCargas, dataDescargas, dataFormatada, hiddenContainer);
            renderTempoPermanenciaChart(dataEntregas, dataFormatada, hiddenContainer);
            
            const filename = `bizdiario_${dataFormatada.replace(/-/g, '')}_0000.pdf`;
            await gerarPDFDoContainer(hiddenContainer, filename);
            hiddenContainer.innerHTML = '';
            showToast("Relatório diário em PDF emitido automaticamente!");
            
            renderDashboard(today);
        }
        
        function salvarUsuario(event) {
            event.preventDefault();
            const form = event.target;
            const nome = form.userName.value;
            const cpf = form.userCpf.value;
            const cel = form.userCel.value;
            const email = form.userEmail.value;
            const usuario = form.userUsername.value;
            const senha = form.userPassword.value;
            const confirmarSenha = form.userConfirmPassword.value;
            const senhaAdmin = form.adminPasswordUserModal.value;
            const feedbackElement = document.getElementById('adminPasswordFeedback');
        
            if (senha !== confirmarSenha) {
                showToast("As senhas não coincidem!");
                return;
            }
        
            if (senhaAdmin !== MASTER_PASSWORD) {
                feedbackElement.textContent = 'Senha de administrador incorreta.';
                feedbackElement.style.display = 'block';
                showToast("Senha de administrador incorreta.");
                return;
            } else {
                feedbackElement.style.display = 'none';
            }
        
            const usuarios = getUsuarios();
            
            const novoUsuario = {
                nome,
                cpf,
                cel,
                email,
                usuario,
                senha: btoa(senha) 
            };
        
            usuarios.push(novoUsuario);
            localStorage.setItem('usuarios', JSON.stringify(usuarios));
            addLog('Criação de Usuário', { novoUsuario: novoUsuario.usuario });
        
            form.reset();
            userModal.hide();
            showToast("Usuário salvo com sucesso!");
        }

        function exportarLogs() {
            document.getElementById('masterPasswordInput').value = '';
            document.getElementById('masterPasswordFeedback').textContent = '';
            masterPasswordModal.show();
        }

        function confirmExportLogs() {
            const password = document.getElementById('masterPasswordInput').value;
            const feedbackElement = document.getElementById('masterPasswordFeedback');

            if (password !== MASTER_PASSWORD) {
                feedbackElement.textContent = 'Senha incorreta.';
                return;
            }

            const logs = getLogs();
            if (logs.length === 0) {
                showToast("Nenhum log para exportar.");
                masterPasswordModal.hide();
                return;
            }

            let logText = "Log de Atividades do Sistema\n\n";
            logs.forEach(log => {
                const logDate = new Date(log.timestamp);
                const timestampStr = `${logDate.toLocaleDateString('pt-BR')} ${logDate.toLocaleTimeString('pt-BR', { hour12: false })}`;
                logText += `Data/Hora: ${timestampStr}\n`;
                logText += `Usuário: ${log.user}\n`;
                logText += `Ação: ${log.action}\n`;
                logText += `Detalhes: ${JSON.stringify(log.details, null, 2)}\n\n`;
            });

            const blob = new Blob([logText], { type: "text/plain;charset=utf-8" });
            const dataHora = new Date();
            const filename = `biz_logs_${dataHora.getFullYear()}-${(dataHora.getMonth() + 1).toString().padStart(2, '0')}-${dataHora.getDate().toString().padStart(2, '0')}.txt`;
            saveAs(blob, filename);
            showToast("Logs exportados com sucesso!");
            masterPasswordModal.hide();
        }
    </script>
</body>
</html>
